---
title: "BassDummyAnalysis"
author: "Camille"
date: "2/7/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
#check working directory 
getwd()

# load packages
pacman::p_load(ggplot2, knitr, BIOMASS, dplyr, data.table, gdata, 
               rvest, rlang, purrr, tidyverse, iNEXT, ggpubr)

#load data
dummy_plots <- read.csv("Data_USE_ME.csv")
bioclim_data <- read.csv("worldclim_bass.csv")

```

```{r Explore Data}
dim(dummy_plots)
colnames(dummy_plots)

dummy_plots$ID[dummy_plots$ID=="#N/A"] <- NA
dummy_plots$ID[dummy_plots$ID==""] <- NA

dummy_plots <- dummy_plots[!is.na(dummy_plots$ID),]

dummy_plots <- dummy_plots[dummy_plots$Height..meters. >= 1.5,]

#create df for just trees
dummy_plots_trees <- dummy_plots %>%
  filter(Type_Field != "Liana")%>%
  select(Project, Plot, Grid, TAG_SUM, DBH..mm., Height..meters., ID)%>%
  mutate(Project2 = Project)%>%
  unite("Project_Plot", Project:Plot)
names(dummy_plots_trees)[4]<- "dbh"
names(dummy_plots_trees)[5]<- "height"

#create liana data
dummy_plots_liana <- dummy_plots %>%
  filter(Type_Field == "Liana")%>%
  select(Project, Plot, Grid, TAG_SUM, DBH..mm., Height..meters.)%>%
  mutate(Project2 = Project)%>%
  unite("Project_Plot", Project:Plot)
names(dummy_plots_liana)[4]<- "dbh"
names(dummy_plots_liana)[5]<- "height"

#visually explore data

ggplot(data = dummy_plots_trees, aes(x=dbh))+
  geom_histogram()

ggplot(data = dummy_plots_trees, aes(x=height))+
  geom_histogram()

summary(dummy_plots_trees)

unique(dummy_plots$Project_Plot)
dummy_plots_trees <- dummy_plots_trees[dummy_plots_trees$Project_Plot!="_",]

```

Height models 
```{r}
 hplots <- unique(dummy_plots_trees$Project_Plot)
  output <- list()
  
height_no <- dummy_plots_trees %>%
  drop_na(height)%>%
  group_by(Project_Plot)%>%
  summarise(n_height=length(height))

Hcalc <- function(ddat, hdat, x){
  
   print(x)
      
      hmod <- data.frame(modelHD(D = hdat$dbh, H = hdat$height, useWeight = F, method = NULL))
       min_pick <- min(hmod$RSE, na.rm = T)
        bm <- hmod$method[hmod$RSE == min_pick]
         best_mod <- modelHD(D = hdat$dbh, H = hdat$height, useWeight = F, method = bm) 
          predHt <- retrieveH(D = ddat$dbh, model = best_mod)

       list(rsq = best_mod$R.squared, rse = best_mod$RSE, mod = best_mod$method, 
                           H = predHt$H, dat = ddat)
}

all_hts <- lapply(1:length(unique(dummy_plots_trees$Project_Plot)), function(x) output[[x]] = Hcalc(ddat = 
                                                    dummy_plots_trees[dummy_plots_trees$Project_Plot == hplots[[x]], ], 
                                                    hdat = dummy_plots_trees[dummy_plots_trees$Project_Plot == hplots[[x]],], 
                                                    x))
rsq <- unlist(lapply(all_hts, `[[`, "rsq"))
rse <- unlist(lapply(all_hts, `[[`, "rse"))
mod <- unlist(lapply(all_hts, `[[`, "mod"))
hts <- unlist(lapply(all_hts, `[[`, "H"))
data <- unlist(lapply(all_hts, `[[`, "dat"))

dummy_plots_trees2 <- data.frame(do.call("rbind", (lapply(all_hts, `[[`, "dat"))))

length(hts)

dummy_plots_trees2$H <- hts 


```



AGB Analysis
```{r}
# clean the ID 

# At the species level, we leave them as separate species ? 

dummy_plots_trees2$Species <-  dummy_plots_trees2$ID
dummy_plots_trees2 <- dummy_plots_trees2 %>% separate(ID, c("Genus", "Spp"))
dummy_plots_trees2$Spp[dummy_plots_trees2$Genus=="ECH"] <- NA
dummy_plots_trees2$Species[dummy_plots_trees2$Genus=="ECH"] <- NA
dummy_plots_trees2$Genus[dummy_plots_trees2$Genus=="ECH"] <- NA
dummy_plots_trees2$Species[dummy_plots_trees2$Spp=="sp"] <- NA
dummy_plots_trees2$Species[dummy_plots_trees2$Spp=="sp"] <- NA
dummy_plots_trees2$Spp[dummy_plots_trees2$Spp=="sp"] <- NA
dummy_plots_trees2$Spp[dummy_plots_trees2$Genus=="Morpho"] <- NA
dummy_plots_trees2$Species[dummy_plots_trees2$Genus=="Morpho"] <- NA
dummy_plots_trees2$Genus[dummy_plots_trees2$Genus=="Morpho"] <- NA
dummy_plots_trees2$Species[dummy_plots_trees2$Spp=="1"] <- NA
dummy_plots_trees2$Spp[dummy_plots_trees2$Spp=="1"] <- NA
dummy_plots_trees2$Species[dummy_plots_trees2$Spp=="3"] <- NA
dummy_plots_trees2$Spp[dummy_plots_trees2$Spp=="3"] <- NA
dummy_plots_trees2$Species <- gsub(" ", "_", dummy_plots_trees2$Species)

#dummy_plots_trees3 <- dummy_plots_trees2[dummy_plots_trees2$Genus!="Liane",]

#get wood density
WdDen <- getWoodDensity(genus = dummy_plots_trees2$Genus,
          species = dummy_plots_trees2$Species,
          stand = dummy_plots_trees2$Project_Plot)

dummy_plots_trees2$meanWD <- WdDen$meanWD
dummy_plots_trees2$sdWD <- WdDen$sdWD

#calculate AGB for trees
dummy_plots_trees2$AGBtree <- computeAGB(D = dummy_plots_trees2$dbh, WD = dummy_plots_trees2$meanWD, H = dummy_plots_trees2$H)

```

Structure (Abundance and Size)
```{r}
#for 6 plots 
plot_abundance <- dummy_plots_trees2 %>%
  group_by(Project_Plot)%>%
  drop_na(dbh, H)%>%
  dplyr::summarise(abundance = n(),
                   mean_dbh = mean(dbh), 
                   mean_height = mean(H), 
                   agb = sum(AGBtree))

#for all plots, where possible 
dummy_plots_all <- read.csv("Data_USE_ME.csv")
dummy_plots_all$Forest_Type <- dummy_plots_all
dummy_plots_all<- dummy_plots_all %>%
  filter(Type_Field != "Liana")%>%
  select(Project, Plot, Grid, TAG_SUM, DBH..mm., Height..meters.)%>%
  mutate(Project2 = Project)%>%
  unite("Project_Plot", Project:Plot)
names(dummy_plots_all)[4]<- "dbh"
names(dummy_plots_all)[5]<- "height"
dummy_plots_all <- dummy_plots_all[dummy_plots_all$Project_Plot!="_",]

dummy_plots_all$BA <- ((dummy_plots_all$dbh/200)^2)*pi 

abundance_all <- dummy_plots_all %>%
  group_by(Project_Plot)%>%
  dplyr::summarise(abundance = n())

ba_all <- dummy_plots_all %>%
  drop_na(BA)%>%
  group_by(Project_Plot)%>%
  dplyr::summarise( BA = sum(BA))

structure_all <- dummy_plots_all %>%
  drop_na(dbh, height)%>%
  group_by(Project_Plot)%>%
  dplyr::summarise(meanDBH = mean(dbh),
                   meanHeight= mean(height))

# also calculate basal area 

structure_all <- merge(structure_all, abundance_all, by="Project_Plot")
structure_all <- merge(structure_all, ba_all, by="Project_Plot")
structure_all$Forest_Type <- c("DF", "DF","DF","DF","DF","DF","DF","DF","DF","DF","DF","DF","IF","IF","IF","IF","IF","IF")

#only small trees
abundance_sm <- dummy_plots_all %>%
  filter(dbh < 30)%>%
  group_by(Project_Plot)%>%
  dplyr::summarise(abundance_sm = n(),
                   abundance_sm_sd = sd(n()))

#only medium trees
abundance_m <- dummy_plots_all %>%
  filter(dbh >= 30& dbh <70)%>%
  group_by(Project_Plot)%>%
  dplyr::summarise(abundance_m = n())
#only lg trees
abundance_lg <- dummy_plots_all %>%
  filter(dbh >70)%>%
  group_by(Project_Plot)%>%
  dplyr::summarise(abundance_lg = n())

#only small trees
BA_sm <- dummy_plots_all %>%
  filter(dbh < 30)%>%
  group_by(Project_Plot)%>%
  dplyr::summarise(BA_sm = sum(BA),
                   BA_sm_sd = sd(BA))
#only medium trees
BA_m <- dummy_plots_all %>%
  filter(dbh >= 30& dbh <70)%>%
  group_by(Project_Plot)%>%
  dplyr::summarise(BA_m = sum(BA),
                   BA_m_sd = sd(BA))
#only lg trees
BA_lg <- dummy_plots_all %>%
  filter(dbh >70)%>%
  group_by(Project_Plot)%>%
  dplyr::summarise(BA_lg = sum(BA),
                   BA_lg_sd = sd(BA))

structure_all <- merge(structure_all, abundance_sm, by="Project_Plot")
structure_all <- merge(structure_all, abundance_m, by="Project_Plot")
structure_all <- merge(structure_all, abundance_lg, by="Project_Plot")
structure_all <- merge(structure_all, BA_sm, by="Project_Plot")
structure_all <- merge(structure_all, BA_m, by="Project_Plot")
structure_all <- merge(structure_all, BA_lg, by="Project_Plot")

ggplot(data= dummy_plots_all, aes(x= height))+
  geom_histogram()+
  theme_classic()
```

Diversity Analysis
```{r}
hill_dat <- data.frame(xtabs(~Project_Plot + Genus, data = dummy_plots_trees2))

hill_dat2 <- hill_dat %>% 
  pivot_wider(names_from = "Genus", values_from = "Freq")
class(hill_dat2)
hill_dat2_list <- as.list(hill_dat2)

hill_dat3 <- hill_dat %>% 
  pivot_wider(names_from = "Project_Plot", values_from = "Freq")
hill_dat4 <- hill_dat3[-c(0,1)]
hill_dat4_list <- as.list(hill_dat4)

hill <- iNEXT(hill_dat4_list, q = c(0,1,2), datatype = "abundance")
hill <- as.data.frame(hill[[3]])
hill2 <- hill %>% 
  select(Site, Diversity, Observed)%>%
  pivot_wider(names_from = "Diversity", values_from = "Observed")
colnames(hill2)[1] <- "Project_Plot"

summary_stats <- merge(hill2, plot_abundance, by="Project_Plot")
colnames(summary_stats)[2] <- "Genus_Richness"
colnames(summary_stats)[3] <- "Shannon_Diversity"
colnames(summary_stats)[4] <- "Simpson_Diversity"


```

```{r Structure Figures}
structure_all$Forest_Type[structure_all$Forest_Type=="DF"] <- "Defaunated"
structure_all$Forest_Type[structure_all$Forest_Type=="IF"] <- "Intact"

abundance_plot <- ggplot(data=structure_all, aes(x= Forest_Type, y= abundance))+
  geom_boxplot()+
  theme_classic()+
  ylab("Abundance")+
  xlab("Forest Type")

height_plot <- ggplot(data=structure_all, aes(x= Forest_Type, y= meanHeight))+
  geom_boxplot()+
  theme_classic()+
  ylab("Mean Height")+
  xlab("Forest Type")

dbh_plot <- ggplot(data=structure_all, aes(x= Forest_Type, y= meanDBH))+
  geom_boxplot()+
  theme_classic()+
  ylab("Mean DBH")+
  xlab("Forest Type")

ggarrange(abundance_plot, height_plot, dbh_plot, labels = c("a", "b", "c"))

#abundance by size class

abundance_dat <- structure_all %>%
  select(abundance, abundance_sm, abundance_m, abundance_lg, Project_Plot, Forest_Type, BA, BA_sm, BA_m, BA_lg)%>%
  pivot_longer(cols= c(abundance:abundance_lg,BA:BA_lg), names_to = "SizeClass")%>%
  separate(SizeClass, c("Structure", "SizeClass"))
abundance_dat$SizeClass[is.na(abundance_dat$SizeClass)]<- "All"
abundance_dat$SizeClass[abundance_dat$SizeClass=="sm"]<- "Small"
abundance_dat$SizeClass[abundance_dat$SizeClass=="m"]<- "Medium"
abundance_dat$SizeClass[abundance_dat$SizeClass=="lg"]<- "Large"
abundance_dat$Structure[abundance_dat$Structure=="abundance"]<- "Abundance"
abundance_dat$Structure[abundance_dat$Structure=="BA"]<- "Basal Area"
colnames(abundance_dat)[2] <- "Forest Type" 
abundance_dat1 <- abundance_dat[abundance_dat$Structure=="Abundance",]
abundance_dat2 <- abundance_dat[abundance_dat$Structure=="Basal Area",]


abundance_dat1_sd <- abundance_dat1 %>%
  group_by(`Forest Type`, Structure, SizeClass)%>%
  dplyr::summarise(sd = sd(value), 
                   value= mean(value),
                   n= n())%>%
mutate(se = sd / sqrt(n),
         lower.ci = value - qt(1 - (0.05 / 2), n - 1) * se,
         upper.ci = value + qt(1 - (0.05 / 2), n - 1) * se)

abundance_dat2_sd <- abundance_dat2 %>%
  group_by(`Forest Type`, Structure, SizeClass)%>%
  dplyr::summarise(sd = sd(value), 
                   value= mean(value),
                   n= n())%>%
mutate(se = sd / sqrt(n),
         lower.ci = value - qt(1 - (0.05 / 2), n - 1) * se,
         upper.ci = value + qt(1 - (0.05 / 2), n - 1) * se)

abundance <- ggplot(data=abundance_dat1_sd, aes(x= SizeClass, y= value, fill=`Forest Type`))+
  geom_col(position="dodge")+
  theme_classic()+
  ylab("Abundance (Individuals)")+
  xlab("Tree Size Class")+
  scale_fill_manual(values = c("darkorange3","forestgreen"))+
  geom_errorbar(aes(ymin = lower.ci, ymax = upper.ci), width = 0.2, position=position_dodge(0.85)) 


basal_area <- ggplot(data=abundance_dat2_sd, aes(x= SizeClass, y= value, fill=`Forest Type`))+
  geom_col(position="dodge")+
  theme_classic()+
  ylab(expression("Basal Area"~ "("~ m^2~")"))+
  xlab("Tree Size Class")+
  scale_fill_manual(values = c("darkorange3","forestgreen"))+
  geom_errorbar(aes(ymin = lower.ci, ymax = upper.ci), width = 0.2, position=position_dodge(0.85)) 


height_plot <- ggplot(data=structure_all, aes( x= Forest_Type, y=meanHeight))+
  geom_boxplot(fill = c("darkorange3","forestgreen"))+
  ylab("Mean Height (m)")+
  xlab("Forest Type")+
  theme(axis.text.x = element_text(color="black"),
          axis.text.y = element_text(color="black"))

dbh_plot <- ggplot(data=structure_all, aes( x= Forest_Type, y=meanDBH))+
  geom_boxplot(fill = c("darkorange3","forestgreen"))+
  ylab("Mean Height (m)")+
  xlab("Forest Type")+
  theme(axis.text.x = element_text(color="black"),
          axis.text.y = element_text(color="black"))

library(ggpubr)

Structure_plot <- ggarrange(abundance, basal_area,height_plot, dbh_plot, labels = c("a", "b", "c", "d"), common.legend = T)

```



```{r}
summary(lm(data=summary_stats, Species_Richness ~ mean_agb))
summary(lm(data=summary_stats, Shannon_Diversity ~ mean_agb))
```

Spatial Variables 
```{r}
bioclim_data

bioclim.pca <- princomp(bioclim_data[,-c(1:2,22:40)])

# print shows you the eigenvalues;
print(bioclim.pca)
# summary does the same but adds the raw and cumulative variance:
summary(bioclim.pca) 

```
edit
